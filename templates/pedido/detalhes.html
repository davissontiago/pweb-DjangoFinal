{% extends "base.html" %}


{% block titulo_conteudo %} Detalhes do Pedido #{{ pedido.id }} {% endblock titulo_conteudo %}


{% block conteudo %} 


<p><strong>Cliente:</strong> {{ pedido.cliente.nome }}</p>
<p><strong>Data do Pedido:</strong> {{ pedido.data_pedidof }}</p>
<p><strong>Status:</strong> {{ pedido.get_status_display }}</p>


<hr>
<h5>Adicionar Produto</h5>
<form method="POST">
    {% csrf_token %}
    <p>
     <label for="id_produto_nome">Produto:</label>    
    <input type="text" class="form-control autocomplete" 
            id="id_produto_nome" 
            data-url="{% url 'buscar_dados' 'home.Produto' %}" 
            value="{{item_pedido.produto.nome}}" 
            data-hidden="#id_produto" >
    {{ form.as_p }}
    <button type="submit" class="btn btn-primary btn-sm">Salvar Produto</button>
    <button type="button" onclick="location=''" class="btn btn-primary btn-sm">Registrar Pagamento</button>
</form>
<hr>
<!-- Tabela de Itens já adicionados ao pedido -->
<h5>Itens do Pedido</h5>
<table class="table table-striped">
    <thead>
        <tr>
            <th>Produto</th>
            <th>Quantidade</th>
            <th>Preço Unitário (R$)</th>
            <th>Total (R$)</th>
            <th>Ações</th>
        </tr>
    </thead>
    <tbody>
        {% for item in pedido.itempedido_set.all %}
        <tr>
            <td>{{ item.produto.nome }}</td>
            <td>{{ item.qtde }}</td>
            <td>{{ item.preco }}</td>
            <td>?</td>
            <td>
              <a href="#" class="btn btn-warning btn-sm">Editar</a>
              <a href="#" class="btn btn-danger btn-sm" 
              onclick="return confirm('Tem certeza que deseja remover este item?');">Remover</a>
            </td>         
        </tr>
        {% endfor %}
    </tbody>
</table>

{% endblock conteudo %}


{% block javascript %}

<script>
    $(document).ready(function() {
        
        // Esta função pega TODOS os inputs com a classe 'autocomplete'
        $('.autocomplete').each(function() {
            var $input = $(this);                 // O campo de texto atual
            var url = $input.data('url');         // A URL específica (Categoria, Cliente ou Produto)
            var hiddenSelector = $input.data('hidden'); // O ID do campo oculto correspondente
            var $hidden = $(hiddenSelector);

            $input.autocomplete({
                source: function(request, response) {
                    $.ajax({
                        url: url,
                        dataType: "json",
                        data: {
                            q: request.term // Termo digitado
                        },
                        success: function(data) {
                            // O Django retorna uma lista de dicionários
                            response(data);
                        },
                        error: function(xhr) {
                            console.log("Erro na busca: " + xhr.statusText);
                        }
                    });
                },
                minLength: 1, // Começa a buscar com 1 letra (pode aumentar para 2 ou 3)
                select: function(event, ui) {
                    // Quando o usuário clica numa opção:
                    
                    // 1. Preenche o campo de texto com o Nome (label)
                    $input.val(ui.item.label);
                    
                    // 2. Preenche o campo oculto com o ID (value/id)
                    $hidden.val(ui.item.id);
                    
                    // Impede o comportamento padrão de substituir o texto pelo ID
                    return false;
                }
            });
        });
        
    });
</script>

<script>
    $('#confirm-btn').confirmation({
      rootSelector: '#confirm-btn',
      title: 'Você tem certeza?',
      btnOkLabel: 'Sim',
      btnCancelLabel: 'Não',
      onConfirm: function() {
        alert('Confirmado!');
      },
      onCancel: function() {
        alert('Cancelado!');
      }
    });
  </script>


{% endblock javascript %}
